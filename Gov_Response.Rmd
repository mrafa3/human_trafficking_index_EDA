---
title: "HTC Analysis: Government Response Request"
author: "Mickey Rafa"
date: "September 13, 2018"
output:
  html_notebook:
    toc: yes
  html_document:
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
    toc_depth: '3'
---

Hi Mick:

Do you think you could aggregate up the government response dataset and send me the sum value for all countries in Africa?  This is for the EU organized crime index.  It's needed by the end of September, but we'll want to look at the results (with Ollie) much earlier.  It may catalyze that work as well, which would be nice.  

# Setup

```{r setup, include=TRUE, message=FALSE}
library(tidyverse)
library(extrafont)
library(ggalt)
library(viridis)
```

```{r themes, include=FALSE}
my.theme <- theme(
  plot.title = element_text(family="Gill Sans MT", color="black", face="bold", size=20, hjust=0), 
  plot.subtitle = element_text(family="Gill Sans MT", color="black", size=15, hjust=0), 
  axis.title = element_text(family="Gill Sans MT", color="black", face="bold", size=14), 
  axis.text = element_text(family="Gill Sans MT", color="black", size=13), 
  plot.caption = element_text(family="Gill Sans MT", color="black", size=13), 
  panel.background = element_rect(fill = "#F7F7F7", colour = NA), 
  panel.grid.major = element_line(colour = "grey90", size = 0.5),
  panel.grid.minor = element_line(colour = "grey93", size = 0.5),
  panel.border = element_rect(colour = "black", size = 0.5, fill=NA, linetype = 1),
  legend.title = element_blank(), 
  legend.text = element_text(family="Gill Sans MT", color="black", size=18, hjust=0),
  legend.position = 'top',
  strip.text = element_text(family="Gill Sans MT", color="black", face="bold", size=16),
  strip.background = element_rect(fill = "white"))

map.theme <- theme(text = element_text(family = "Gill Sans MT", color = "#FFFFFF"), 
                   panel.background = element_rect(fill = "#444444"),
                   plot.background = element_rect(fill = "#444444"),
                   panel.grid = element_blank(),
                   plot.title = element_text(size = 50),
                   plot.subtitle = element_text(size = 25),
                   plot.caption = element_text(size = 20), 
                   axis.text = element_blank(),
                   axis.title = element_blank(),
                   axis.ticks = element_blank(),
                   legend.position = "bottom", 
                   legend.key.size = unit(1, "cm"),
                   legend.background = element_rect(fill="#444444"),
                   legend.title = element_blank())
```

```{r read_data, include=TRUE, message=FALSE}
df_HTC <- read_csv('.//data/HTC Country year coding and indices v3.1.csv')

africa <- read_csv('.//data/africa.csv')
```

# Initial data analysis steps 

## Multiple CY-Observations

There are many instances with multiple observations for the same country-year pairing. These are not exact duplicates, though, so determining which observation to go with is outside of this analysis. I am identifying these records and removing them.

```{r clean4, echo=TRUE}
clean_mult_obs <- df_HTC %>% 
  mutate(CY=paste(country, year))

sub_df_HTC <- duplicated(clean_mult_obs[,"CY"])
```

There are 94 instances of multiple observations for the same country-year pairing.

```{r}
sum(sub_df_HTC)
```

```{r}
df_HTC_mult_obs <- df_HTC[sub_df_HTC,]

df_HTC <- df_HTC[!sub_df_HTC,]
```

## Data preparation 

```{r colnames, include=FALSE}
names(df_HTC)
```

First, peeling out the government response variables from the master dataset.

```{r select_gov_resp, include=TRUE}
df_HTC_gov <- df_HTC %>% 
  select(2, 4, 64:160)

head(df_HTC_gov)
```

```{r group_by, include=TRUE}
(df_HTC_gov_agg <- df_HTC_gov %>% 
  gather(variable, value, 3:99) %>% 
  group_by(country, year, variable) %>% 
  summarise(sum_gov_response = sum(value, na.rm=TRUE)))
```

## Applying negative valences

```{r neg_valence_vars, include=TRUE}
neg_valence <- c('draft_law', 'no_law', 'corruption_sug', 'none_encourag', 
                 'no_legal_alts', 'no_residency', 'no_legal_aid', 'no_systematic_id',
                 'vic_punish', 'no_nonpunish_law', 'no_shelter', 'inadeq_shelter',
                 'failcoop_io', 'inadeq_coop_io', 'failcoop_ngo', 'no_transparen',
                 'no_na_plan', 'unimplement_plan', 'no_pk_train', 'pk_abuse', 'no_demand_prgm')
```

```{r}
df_HTC_gov_agg_2 <- df_HTC_gov_agg %>% 
  mutate(new_value = ifelse(variable %in% neg_valence, sum_gov_response * -1, sum_gov_response))
```

```{r}
df_HTC_gov_agg_3 <- df_HTC_gov_agg_2 %>% 
  ungroup() %>% 
  group_by(country, year) %>% 
  summarise(sum_gov_response = sum(new_value, na.rm = TRUE))
```


```{r df_final, include=TRUE}
df_final <- df_HTC_gov_agg_3 %>%  
  full_join(x=.,
            y=africa,
            by='country')
```

```{r}
df_final %>% 
  select(1:3) %>% 
  spread(year, sum_gov_response) %>% 
  select(-17) %>% 
  write.csv(., './/output_tables/df_gov_response.csv')
```


```{r fig.height=6.2}
df_final %>% 
  filter(continent == 'Africa') %>% 
  ggplot(.,
         aes(x=year,
             y=sum_gov_response,
             group=country)) + 
  geom_line() + 
  geom_point()
```

```{r write_allcountries, include=TRUE}
df_final %>% 
  select(1:3) %>% 
  spread(year, sum_gov_response) %>% 
  write.csv('.//output_tables/sum_govresponse_allcountries_Sept2018.csv')
```

```{r write_africa, include=TRUE}
df_final %>% 
  filter(continent == 'Africa') %>% 
  select(1:3) %>% 
  spread(year, sum_gov_response) %>% 
  write.csv('.//output_tables/sum_govresponse_africa_Sept2018.csv')
```

```{r}
df_max_year <- df_final %>% 
  slice(which.max(year)) %>% 
  mutate(Max_year = 'Max year') %>% 
  select(1:4, 6)

df_min_year <- df_final %>% 
  slice(which.min(year)) %>% 
  mutate(Min_year = 'Min year') %>% 
  select(1:3, 6)

df_change <- df_max_year %>% 
  left_join(x=.,
            y=df_min_year,
            by='country') %>% 
  filter(continent == 'Africa')
```


```{r}
df_change <- df_change %>% 
  mutate(change_gov_response = sum_gov_response.x - sum_gov_response.y) %>% 
  rename('Earliest' = sum_gov_response.y,
         'Most Recent' = sum_gov_response.x,
         'Earliest Year' = year.y,
         'Most Recent Year' = year.x)

df_change$country <- factor(df_change$country, 
                            levels = df_change$country[order(abs(df_change$change_gov_response))])

c_order <- df_change %>% 
  arrange(desc(abs(change_gov_response))) %>% 
  select(country)

c_order <- c_order$country
```

```{r fig.height=6.2, include=FALSE}
df_change %>% 
  ggplot(.) + 
  geom_dumbbell(aes(x=`Earliest`,
                    xend=`Most Recent`,
                    y=reorder(country, change_gov_response)), 
                size_x = 5, size_xend = 5, dot_guide = FALSE) + 
  ggtitle('Change in sum government response variables') +   
  #annotate("text", x = 8, y = 54, label = "Earlest",  
   #        color = 'black', size = 4, family="Gill Sans MT", fontface = 'bold') + 
  #annotate("text", x = 50, y = 54, label = "Recent",  
   #        color = 'black', size = 4, family="Gill Sans MT", fontface = 'bold') + 
  labs(y='',
       x='Sum Government Response (earliest year vs. most recent year)') + 
  my.theme
```

```{r}
df_change_2 <- df_change %>% 
  select(1,3,7,9) %>% 
  gather(var, val, 2:4)

df_change_2$country <- factor(df_change_2$country, 
                            levels = rev(c_order))

```

```{r fig.height=14, fig.width=9}
df_change_2 %>% 
  filter(var != 'change_gov_response') %>% 
  ggplot(.) + 
  geom_point(aes(x=val,
                 y=country,
                 color=var), size=3) + 
  geom_vline(xintercept = 0, linetype = 'longdash', color = 'gray60') + 
  ggtitle('Change in sum government response variables',
          subtitle='Earliest year of available data vs. most recent') +   
  labs(y='',
       x='Sum of HTI government response codes',
       caption='\nArranged by absolute value of difference between earliest and most recent\nBotswana saw no change in the earliest and most recent values') + 
  my.theme + 
  theme(plot.title = element_text(size=16))
```


```{r}
map.world <- map_data("world")
```



```{r}
map.world <- map.world %>% 
    mutate(region = recode(region, 
                          "CÃ´te d'Ivoire" = 'Ivory Coast',
                          'Democratic Republic of the Congo' = 'Congo, the Democratic Republic of the',
                          'Republic of Congo' = 'Congo',
                          'Cape Verde' = 'Cabo Verde',
                          'Tanzania' = 'Tanzania, United Republic of'))
```

```{r}
joined.world.map <- left_join(x=map.world,
                             y=df_change_2 %>% filter(var == 'Most Recent'),
                             by=c('region' = 'country'))

anti.joined.world.map <- full_join(x=map.world,
                             y=df_change %>% select(1:3),
                             by=c('region' = 'country'))

#anti.joined.world.map %>% 
 # filter(is.na(`Most Recent`),
  #       continent == 'Africa')
```

```{r fig.height=8}
joined.world.map %>% 
  ggplot(.) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = val), color="gray60") +
  scale_fill_viridis() + 
  ggtitle(paste('Map of sum of government response scores'),
          subtitle = 'Most recent values') + 
  #labs(caption = 'Using 2014 value if 2015 is NA') + 
  coord_map(xlim = c(-30, 60),ylim = c(45, -37)) + 
  map.theme + 
  theme(plot.title = element_text(size=24),
        plot.subtitle = element_text(size=18))
```

```{r fig.height=8}
joined.world.map2 <- left_join(x=map.world,
                             y=df_change_2 %>% filter(var == 'change_gov_response'),
                             by=c('region' = 'country'))

joined.world.map2 %>% 
  ggplot(.) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = val), color="gray60") + 
  scale_fill_viridis() +
  ggtitle(paste('Map of sum of government response scores'),
          subtitle = 'Change from earliest to most recent values') + 
  #labs(caption = 'Using 2014 value if 2015 is NA') + 
  coord_map(xlim = c(-30, 60),ylim = c(45, -37)) + 
  map.theme + 
  theme(plot.title = element_text(size=24),
        plot.subtitle = element_text(size=18))
```

